<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå…¨ç”Ÿå‘½èµ·æºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼šåˆ†å­ã‹ã‚‰åŸå§‹ç´°èƒã¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a1929 0%, #001e3c 100%);
            color: #e0f2fe;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0ea5e9;
            position: relative;
        }
        
        h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #0ea5e9, #22d3ee, #2dd4bf);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            animation: titleGlow 3s infinite alternate;
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 0 10px rgba(14, 165, 233, 0.5); }
            100% { text-shadow: 0 0 20px rgba(34, 211, 238, 0.8); }
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #7dd3fc;
            max-width: 800px;
            margin: 0 auto 20px;
        }
        
        .simulation-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            height: 85vh;
        }
        
        #mainCanvas {
            background: linear-gradient(to bottom, 
                rgba(2, 8, 23, 0.9) 0%,
                rgba(12, 74, 110, 0.3) 50%,
                rgba(30, 64, 175, 0.1) 100%);
            border: 3px solid #1d4ed8;
            border-radius: 10px;
            box-shadow: 
                0 0 50px rgba(14, 165, 233, 0.3),
                inset 0 0 30px rgba(34, 211, 238, 0.1);
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            background: rgba(2, 8, 23, 0.9);
            border: 2px solid #1e3a8a;
            border-radius: 10px;
            padding: 25px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.2);
        }
        
        .panel-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #1e3a8a;
        }
        
        h2 {
            color: #0ea5e9;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h3 {
            color: #22d3ee;
            margin: 15px 0 10px;
            font-size: 1.1rem;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #0ea5e9, #0369a1);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #38bdf8, #0284c7);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(14, 165, 233, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #7dd3fc;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #0ea5e9, #22d3ee);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #f59e0b;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.8);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: rgba(30, 58, 138, 0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
            transition: all 0.3s;
        }
        
        .stat-box:hover {
            background: rgba(30, 58, 138, 0.5);
            transform: translateX(5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #22d3ee;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #bae6fd;
            margin-top: 5px;
        }
        
        #eventLog {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .log-info { background: rgba(14, 165, 233, 0.1); border-left: 3px solid #0ea5e9; }
        .log-success { background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; }
        .log-warning { background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; }
        .log-critical { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .stage-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(2, 8, 23, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #0ea5e9;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.5); }
            50% { box-shadow: 0 0 30px rgba(14, 165, 233, 0.8); }
            100% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.5); }
        }
        
        .end-credits {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1929, #001e3c);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 50px;
        }
        
        .credits-content {
            max-width: 800px;
            text-align: center;
            animation: scrollCredits 40s linear;
        }
        
        @keyframes scrollCredits {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); }
        }
        
        .molecule-structure {
            position: absolute;
            pointer-events: none;
            opacity: 0.7;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(100px, -100px) rotate(360deg); }
        }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(30, 58, 138, 0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #22d3ee, #2dd4bf);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .scientific-note {
            background: rgba(14, 165, 233, 0.05);
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .note-title {
            color: #22d3ee;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="stage-indicator" id="stageIndicator">
        <div style="font-size: 1.2rem; font-weight: bold; color: #22d3ee;">
            ç¾åœ¨ã®æ®µéš: <span id="currentStage">åŒ–å­¦é€²åŒ–æœŸ</span>
        </div>
        <div style="font-size: 0.9rem; color: #7dd3fc; margin-top: 5px;">
            é€²åŒ–é€²æ—: <span id="evolutionProgress">0%</span>
        </div>
    </div>
    
    <div class="container">
        <header>
            <h1>ğŸŒŒ å®Œå…¨ç”Ÿå‘½èµ·æºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
            <p class="subtitle">ç§‘å­¦çš„ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãåˆ†å­ã‹ã‚‰åŸå§‹ç´°èƒã¸ã®å®Œå…¨ãªé€²åŒ–éç¨‹ã®å¯è¦–åŒ–</p>
        </header>
        
        <div class="simulation-container">
            <canvas id="mainCanvas"></canvas>
            
            <div class="control-panel">
                <div class="panel-section">
                    <h2>ğŸ® ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡</h2>
                    <div class="btn-group">
                        <button id="startBtn" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <span>â–¶</span> é–‹å§‹
                        </button>
                        <button id="pauseBtn" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <span>â¸</span> ä¸€æ™‚åœæ­¢
                        </button>
                        <button id="resetBtn" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <span>ğŸ”„</span> ãƒªã‚»ãƒƒãƒˆ
                        </button>
                        <button id="fastForwardBtn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <span>â©</span> æ—©é€ã‚Š
                        </button>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar" id="evolutionProgressBar"></div>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>åˆ†å­åå¿œé€Ÿåº¦:</span>
                            <span id="reactionSpeedValue">æ¨™æº–</span>
                        </div>
                        <input type="range" id="reactionSpeed" min="0" max="4" step="1" value="2">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>æ¸©åº¦ (â„ƒ):</span>
                            <span id="temperatureValue">80</span>
                        </div>
                        <input type="range" id="temperature" min="20" max="120" step="1" value="80">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>pH:</span>
                            <span id="pHValue">5.5</span>
                        </div>
                        <input type="range" id="pH" min="2" max="10" step="0.1" value="5.5">
                    </div>
                </div>
                
                <div class="panel-section">
                    <h2>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="aminoAcidCount">0</div>
                            <div class="stat-label">ã‚¢ãƒŸãƒé…¸åˆ†å­</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="peptideCount">0</div>
                            <div class="stat-label">ãƒšãƒ—ãƒãƒ‰é–</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="lipidCount">0</div>
                            <div class="stat-label">è„‚è³ªåˆ†å­</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="protocellCount">0</div>
                            <div class="stat-label">åŸå§‹ç´°èƒ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="timeElapsed">0</div>
                            <div class="stat-label">çµŒéæ™‚é–“ (ä¸‡å¹´)</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="successRate">0%</div>
                            <div class="stat-label">åå¿œæˆåŠŸç‡</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h2>ğŸ“ é€²åŒ–ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h2>
                    <div id="eventLog"></div>
                </div>
                
                <div class="panel-section">
                    <h2>ğŸ¨ åˆ†å­å‡¡ä¾‹</h2>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FF6B6B;"></div>
                            <span>ã‚°ãƒªã‚·ãƒ³ (Gly)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4ECDC4;"></div>
                            <span>ã‚¢ãƒ©ãƒ‹ãƒ³ (Ala)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #45B7D1;"></div>
                            <span>è„‚è³ªåˆ†å­</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #96CEB4;"></div>
                            <span>çŸ­ãƒšãƒ—ãƒãƒ‰</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FFEAA7;"></div>
                            <span>RNAæ–­ç‰‡</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10B981;"></div>
                            <span>åŸå§‹ç´°èƒ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="end-credits" id="endCredits">
        <div class="credits-content">
            <h1 style="font-size: 4rem; color: #22d3ee; margin-bottom: 50px;">ğŸŒ  ç”Ÿå‘½ã®å¤œæ˜ã‘</h1>
            <p style="font-size: 1.5rem; color: #7dd3fc; margin-bottom: 30px;">
                åœ°çƒå²ä¸Šåˆã®åŸå§‹ç´°èƒã®èª•ç”Ÿ
            </p>
            
            <div style="margin: 50px 0;">
                <h2 style="color: #0ea5e9; margin-bottom: 30px;">ğŸ¬ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</h2>
                
                <div style="margin: 30px 0;">
                    <h3 style="color: #22d3ee;">ğŸ”¬ ç§‘å­¦çš„åŸºç¤ç ”ç©¶</h3>
                    <p style="margin: 10px 0;">Miller-Urey å®Ÿé¨“ (1953) - ç„¡æ©Ÿç‰©ã‹ã‚‰ã‚¢ãƒŸãƒé…¸ç”Ÿæˆã®å®Ÿè¨¼</p>
                    <p style="margin: 10px 0;">ãƒªãƒœã‚¶ã‚¤ãƒ ã®ç™ºè¦‹ (1982) - RNAä¸–ç•Œä»®èª¬ã®ç¢ºç«‹</p>
                    <p style="margin: 10px 0;">è„‚è³ªäºŒé‡è†œã®è‡ªç™ºå½¢æˆç ”ç©¶</p>
                </div>
                
                <div style="margin: 30px 0;">
                    <h3 style="color: #22d3ee;">ğŸŒ‹ åˆæœŸåœ°çƒç’°å¢ƒãƒ‡ãƒ¼ã‚¿</h3>
                    <p style="margin: 10px 0;">ç†±æ°´å™´å‡ºå­”åŒ–å­¦ç’°å¢ƒåˆ†æ</p>
                    <p style="margin: 10px 0;">éš•çŸ³ä¸­ã®æœ‰æ©Ÿç‰©çµ„æˆç ”ç©¶</p>
                    <p style="margin: 10px 0;">åŸå§‹å¤§æ°—çµ„æˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°</p>
                </div>
                
                <div style="margin: 30px 0;">
                    <h3 style="color: #22d3ee;">ğŸ§¬ åˆ†å­é€²åŒ–ãƒ¢ãƒ‡ãƒ«</h3>
                    <p style="margin: 10px 0;">ãƒšãƒ—ãƒãƒ‰çµåˆã‚¨ãƒãƒ«ã‚®ãƒ¼è¨ˆç®—</p>
                    <p style="margin: 10px 0;">åˆ†å­è‡ªå·±çµ„ç¹”åŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>
                    <p style="margin: 10px 0;">åŸå§‹ç´°èƒåˆ†è£‚ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </p>
                </div>
                
                <div style="margin: 50px 0;">
                    <h2 style="color: #0ea5e9;">ğŸ“š å¼•ç”¨ç ”ç©¶è«–æ–‡</h2>
                    <ul style="list-style: none; padding: 0; margin: 20px 0;">
                        <li style="margin: 10px 0;">â€¢ Miller, S. L. (1953). A production of amino acids under possible primitive earth conditions.</li>
                        <li style="margin: 10px 0;">â€¢ Deamer, D. W. (2017). The role of lipid membranes in life's origin.</li>
                        <li style="margin: 10px 0;">â€¢ Szostak, J. W. (2009). Systems chemistry on early Earth.</li>
                    </ul>
                </div>
                
                <div style="margin: 50px 0; padding: 30px; background: rgba(14, 165, 233, 0.1); border-radius: 10px;">
                    <p style="font-size: 1.2rem; color: #22d3ee;">
                        "ç”Ÿå‘½ã®èµ·æºã¯ä¸€åº¦ãã‚Šã®åŒ–å­¦çš„å¥‡è·¡ã§ã¯ãªãã€<br>
                        å®‡å®™çš„å¿…ç„¶æ€§ã«åŸºã¥ãè‡ªå·±çµ„ç¹”åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚ã‚‹"
                    </p>
                </div>
                
                <p style="margin-top: 100px; color: #7dd3fc;">
                    ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº† - ç”Ÿå‘½ã®æ—…ã¯ã“ã“ã‹ã‚‰å§‹ã¾ã£ãŸ
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== ç§‘å­¦çš„å®šæ•°ã¨è¨­å®š ====================
        const SCIENTIFIC_CONSTANTS = {
            // åˆæœŸåœ°çƒç’°å¢ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆç ”ç©¶è«–æ–‡ã«åŸºã¥ãï¼‰
            INITIAL_TEMPERATURE: 80, // â„ƒ (ç†±æ°´å™´å‡ºå­”å‘¨è¾º)
            INITIAL_PH: 5.5,         // å¼±é…¸æ€§
            INITIAL_ION_CONCENTRATION: 0.15, // ä¸»ã«é‰„ã‚¤ã‚ªãƒ³
            
            // åˆ†å­ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãï¼‰
            AMINO_ACID_TYPES: [
                { name: "ã‚°ãƒªã‚·ãƒ³", symbol: "Gly", color: "#FF6B6B", size: 2, 
                  formationEnergy: 1.0, abundance: 0.35 },
                { name: "ã‚¢ãƒ©ãƒ‹ãƒ³", symbol: "Ala", color: "#4ECDC4", size: 2,
                  formationEnergy: 1.2, abundance: 0.25 },
                { name: "ã‚¢ã‚¹ãƒ‘ãƒ©ã‚®ãƒ³é…¸", symbol: "Asp", color: "#FF9E6B", size: 2.5,
                  formationEnergy: 1.5, abundance: 0.15 },
                { name: "ãƒãƒªãƒ³", symbol: "Val", color: "#6BFFD1", size: 2.5,
                  formationEnergy: 1.4, abundance: 0.12 },
                { name: "ãƒ­ã‚¤ã‚·ãƒ³", symbol: "Leu", color: "#D16BFF", size: 3,
                  formationEnergy: 1.6, abundance: 0.08 },
                { name: "ã‚»ãƒªãƒ³", symbol: "Ser", color: "#6B9EFF", size: 2.3,
                  formationEnergy: 1.3, abundance: 0.05 }
            ],
            
            // è„‚è³ªåˆ†å­ï¼ˆè†œå½¢æˆã«å¿…è¦ï¼‰
            LIPID_TYPES: [
                { name: "è„‚è‚ªé…¸", color: "#45B7D1", size: 3, 
                  criticalConcentration: 0.8, membraneStrength: 0.7 },
                { name: "ãƒªãƒ³è„‚è³ª", color: "#456BD1", size: 3.5,
                  criticalConcentration: 0.6, membraneStrength: 0.9 }
            ],
            
            // åå¿œã‚¨ãƒãƒ«ã‚®ãƒ¼é–¾å€¤ï¼ˆkJ/molå˜ä½ã®ç›¸å¯¾å€¤ï¼‰
            REACTION_ENERGIES: {
                PEPTIDE_BOND_FORMATION: 25,    // ãƒšãƒ—ãƒãƒ‰çµåˆå½¢æˆ
                LIPID_AGGREGATION: 15,         // è„‚è³ªé›†åˆ
                MEMBRANE_FORMATION: 40,         // è†œå½¢æˆ
                PROTOCELL_GENESIS: 60           // åŸå§‹ç´°èƒç”Ÿæˆ
            },
            
            // ç¢ºç‡å®šæ•°ï¼ˆå®Ÿé¨“çµæœã«åŸºã¥ãæ¨å®šï¼‰
            PROBABILITIES: {
                AMINO_ACID_FORMATION: 0.0001,    // ã‚¢ãƒŸãƒé…¸ç”Ÿæˆç¢ºç‡
                PEPTIDE_FORMATION: 0.00005,      // ãƒšãƒ—ãƒãƒ‰å½¢æˆç¢ºç‡
                LIPID_FORMATION: 0.00008,        // è„‚è³ªç”Ÿæˆç¢ºç‡
                PROTOCELL_FORMATION: 0.00001     // åŸå§‹ç´°èƒç”Ÿæˆç¢ºç‡
            },
            
            // ç’°å¢ƒã‚¤ãƒ™ãƒ³ãƒˆ
            ENVIRONMENT_EVENTS: {
                HYDROTHERMAL_VENT: {
                    energyBoost: 2.0,
                    organicBoost: 1.5,
                    duration: 50,
                    probability: 0.02
                },
                ELECTRIC_DISCHARGE: {
                    energyBoost: 3.0,
                    organicBoost: 1.2,
                    duration: 10,
                    probability: 0.01
                },
                UV_RADIATION: {
                    energyBoost: 1.5,
                    organicBoost: 1.1,
                    duration: 30,
                    probability: 0.03
                }
            }
        };
        
        // ==================== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ ====================
        const simulation = {
            canvas: null,
            ctx: null,
            isRunning: false,
            time: 0,
            timeScale: 1,
            molecules: [],
            peptides: [],
            lipids: [],
            protocells: [],
            events: [],
            environment: {
                temperature: SCIENTIFIC_CONSTANTS.INITIAL_TEMPERATURE,
                pH: SCIENTIFIC_CONSTANTS.INITIAL_PH,
                ionConcentration: SCIENTIFIC_CONSTANTS.INITIAL_ION_CONCENTRATION,
                organicConcentration: 0.1,
                energy: 50
            },
            statistics: {
                totalMolecules: 0,
                successfulReactions: 0,
                failedReactions: 0,
                peptidesFormed: 0,
                lipidsFormed: 0,
                protocellsBorn: 0,
                totalTime: 0
            }
        };
        
        // ==================== åˆ†å­ã‚¯ãƒ©ã‚¹å®šç¾© ====================
        class AminoAcid {
            constructor(type, x, y) {
                this.id = `AA_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.type = type;
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.energy = 100;
                this.age = 0;
                this.maxAge = 500 + Math.random() * 1000;
                this.bonds = [];
                this.reactionRadius = 5 + type.size;
                this.color = type.color;
                this.size = type.size;
                this.formationTime = simulation.time;
                
                simulation.molecules.push(this);
                simulation.statistics.totalMolecules++;
            }
            
            update() {
                // ãƒ–ãƒ©ã‚¦ãƒ³é‹å‹•
                this.x += this.vx * simulation.timeScale;
                this.y += this.vy * simulation.timeScale;
                
                // å¢ƒç•Œå‡¦ç†
                if (this.x < 0 || this.x > simulation.canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > simulation.canvas.height) this.vy *= -1;
                
                // ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»
                this.energy -= 0.01;
                this.age++;
                
                // å¯¿å‘½ãƒã‚§ãƒƒã‚¯
                if (this.energy <= 0 || this.age > this.maxAge) {
                    this.decay();
                    return false;
                }
                
                return true;
            }
            
            decay() {
                const index = simulation.molecules.indexOf(this);
                if (index > -1) {
                    simulation.molecules.splice(index, 1);
                    // åˆ†è§£æ™‚ã«æœ‰æ©Ÿç‰©ã‚’ç’°å¢ƒã«æˆ»ã™
                    simulation.environment.organicConcentration += 0.01;
                }
            }
            
            draw() {
                simulation.ctx.save();
                
                // åˆ†å­ã®æç”»
                simulation.ctx.fillStyle = this.color;
                simulation.ctx.beginPath();
                simulation.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                simulation.ctx.fill();
                
                // åˆ†å­ã®è¼ãï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ã«æ¯”ä¾‹ï¼‰
                const glowIntensity = this.energy / 100;
                if (glowIntensity > 0.3) {
                    simulation.ctx.strokeStyle = `rgba(255, 255, 255, ${glowIntensity * 0.5})`;
                    simulation.ctx.lineWidth = 1;
                    simulation.ctx.beginPath();
                    simulation.ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                    simulation.ctx.stroke();
                }
                
                // çµåˆã®æç”»
                this.bonds.forEach(bond => {
                    simulation.ctx.strokeStyle = `rgba(255, 255, 255, 0.3)`;
                    simulation.ctx.lineWidth = 1;
                    simulation.ctx.beginPath();
                    simulation.ctx.moveTo(this.x, this.y);
                    simulation.ctx.lineTo(bond.target.x, bond.target.y);
                    simulation.ctx.stroke();
                });
                
                simulation.ctx.restore();
            }
        }
        
        class Peptide {
            constructor(aminoAcids, x, y) {
                this.id = `PEP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.aminoAcids = aminoAcids;
                this.sequence = aminoAcids.map(aa => aa.type.symbol).join('-');
                this.length = aminoAcids.length;
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = (Math.random() - 0.5) * 1.5;
                this.energy = 150;
                this.age = 0;
                this.maxAge = 1000 + this.length * 100;
                this.size = 4 + this.length * 0.5;
                this.color = this.calculateColor();
                this.function = this.determineFunction();
                this.replicationChance = 0.001 * this.length;
                
                simulation.peptides.push(this);
                simulation.statistics.peptidesFormed++;
                
                this.logEvent(`æ–°ã—ã„ãƒšãƒ—ãƒãƒ‰é–ãŒå½¢æˆã•ã‚Œã¾ã—ãŸ: ${this.sequence} (${this.length}æ®‹åŸº)`);
            }
            
            calculateColor() {
                // é…åˆ—é•·ã«åŸºã¥ã„ã¦è‰²ã‚’è¨ˆç®—
                const hue = (this.length * 30) % 360;
                return `hsl(${hue}, 70%, 60%)`;
            }
            
            determineFunction() {
                // å˜ç´”ãªæ©Ÿèƒ½äºˆæ¸¬
                if (this.length < 5) return "æ§‹é€ ä¸å®‰å®š";
                if (this.length >= 5 && this.length < 10) return "é‡‘å±çµåˆèƒ½";
                if (this.length >= 10 && this.length < 15) return "è§¦åª’æ´»æ€§";
                return "è†œçµåˆèƒ½";
            }
            
            update() {
                this.x += this.vx * simulation.timeScale;
                this.y += this.vy * simulation.timeScale;
                
                if (this.x < 0 || this.x > simulation.canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > simulation.canvas.height) this.vy *= -1;
                
                this.energy -= 0.02;
                this.age++;
                
                // è‡ªå·±è¤‡è£½ã®å¯èƒ½æ€§
                if (this.energy > 100 && Math.random() < this.replicationChance * simulation.timeScale) {
                    this.attemptReplication();
                }
                
                if (this.energy <= 0 || this.age > this.maxAge) {
                    this.decay();
                    return false;
                }
                
                return true;
            }
            
            attemptReplication() {
                // ç’°å¢ƒæ¡ä»¶ãŒè‰¯ã‘ã‚Œã°è¤‡è£½ã‚’è©¦ã¿ã‚‹
                if (simulation.environment.energy > 30 && 
                    simulation.environment.organicConcentration > 0.3) {
                    
                    const newPeptide = new Peptide([...this.aminoAcids], this.x + 20, this.y + 20);
                    this.energy *= 0.7;
                    
                    this.logEvent(`ãƒšãƒ—ãƒãƒ‰ ${this.sequence} ãŒè‡ªå·±è¤‡è£½ã‚’è©¦ã¿ã¾ã—ãŸ`);
                }
            }
            
            decay() {
                const index = simulation.peptides.indexOf(this);
                if (index > -1) {
                    simulation.peptides.splice(index, 1);
                    simulation.environment.organicConcentration += 0.05;
                }
            }
            
            draw() {
                simulation.ctx.save();
                
                // ãƒšãƒ—ãƒãƒ‰é–ã®æç”»
                simulation.ctx.fillStyle = this.color;
                simulation.ctx.beginPath();
                simulation.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                simulation.ctx.fill();
                
                // å†…éƒ¨æ§‹é€ ã®è¡¨ç¾
                simulation.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                simulation.ctx.beginPath();
                simulation.ctx.arc(this.x, this.y, this.size * 0.6, 0, Math.PI * 2);
                simulation.ctx.fill();
                
                // æ©Ÿèƒ½è¡¨ç¤º
                simulation.ctx.fillStyle = 'white';
                simulation.ctx.font = '10px Arial';
                simulation.ctx.textAlign = 'center';
                simulation.ctx.fillText(this.function, this.x, this.y + this.size + 12);
                
                simulation.ctx.restore();
            }
            
            logEvent(message) {
                addLogEntry(message, 'log-success');
            }
        }
        
        class Lipid {
            constructor(type, x, y) {
                this.id = `LIP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.type = type;
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 1;
                this.vy = (Math.random() - 0.5) * 1;
                this.energy = 120;
                this.age = 0;
                this.size = type.size;
                this.color = type.color;
                this.inMembrane = false;
                this.membrane = null;
                
                simulation.lipids.push(this);
                simulation.statistics.lipidsFormed++;
            }
            
            update() {
                this.x += this.vx * simulation.timeScale;
                this.y += this.vy * simulation.timeScale;
                
                if (this.x < 0 || this.x > simulation.canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > simulation.canvas.height) this.vy *= -1;
                
                this.energy -= 0.015;
                this.age++;
                
                // è†œå½¢æˆã®å¯èƒ½æ€§
                if (!this.inMembrane && this.energy > 50) {
                    this.attemptMembraneFormation();
                }
                
                if (this.energy <= 0) {
                    this.decay();
                    return false;
                }
                
                return true;
            }
            
            attemptMembraneFormation() {
                // è¿‘ãã®è„‚è³ªã‚’æ¢ã™
                const nearbyLipids = simulation.lipids.filter(lipid => {
                    if (lipid === this || lipid.inMembrane) return false;
                    const dx = lipid.x - this.x;
                    const dy = lipid.y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    return distance < 20;
                });
                
                if (nearbyLipids.length >= 3) {
                    // è†œã®å½¢æˆ
                    this.inMembrane = true;
                    nearbyLipids.forEach(lipid => lipid.inMembrane = true);
                    
                    const membrane = new LipidMembrane([this, ...nearbyLipids]);
                    this.membrane = membrane;
                    nearbyLipids.forEach(lipid => lipid.membrane = membrane);
                    
                    addLogEntry(`è„‚è³ªåˆ†å­ãŒé›†ã¾ã‚Šã€è†œæ§‹é€ ã‚’å½¢æˆã—ã¾ã—ãŸ`, 'log-success');
                }
            }
            
            decay() {
                const index = simulation.lipids.indexOf(this);
                if (index > -1) {
                    simulation.lipids.splice(index, 1);
                }
            }
            
            draw() {
                simulation.ctx.save();
                
                simulation.ctx.fillStyle = this.color;
                simulation.ctx.beginPath();
                
                if (this.inMembrane) {
                    // è†œã®ä¸­ã§ã¯å°‘ã—å¹³ãŸãæç”»
                    simulation.ctx.ellipse(this.x, this.y, this.size * 1.5, this.size * 0.8, 0, 0, Math.PI * 2);
                } else {
                    simulation.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                }
                
                simulation.ctx.fill();
                
                // è†œåˆ†å­ã®å ´åˆã¯åŒæ¥µæ€§ã‚’è¡¨ç¾
                if (this.type.name === "ãƒªãƒ³è„‚è³ª") {
                    simulation.ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    simulation.ctx.lineWidth = 1;
                    simulation.ctx.beginPath();
                    simulation.ctx.moveTo(this.x - this.size, this.y);
                    simulation.ctx.lineTo(this.x + this.size, this.y);
                    simulation.ctx.stroke();
                }
                
                simulation.ctx.restore();
            }
        }
        
        class LipidMembrane {
            constructor(lipids) {
                this.id = `MEM_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.lipids = lipids;
                this.center = this.calculateCenter();
                this.radius = this.calculateRadius();
                this.integrity = 1.0;
                this.age = 0;
                this.containedMolecules = [];
                this.isProtocell = false;
            }
            
            calculateCenter() {
                const sum = this.lipids.reduce((acc, lipid) => {
                    acc.x += lipid.x;
                    acc.y += lipid.y;
                    return acc;
                }, { x: 0, y: 0 });
                
                return {
                    x: sum.x / this.lipids.length,
                    y: sum.y / this.lipids.length
                };
            }
            
            calculateRadius() {
                const maxDistance = Math.max(...this.lipids.map(lipid => {
                    const dx = lipid.x - this.center.x;
                    const dy = lipid.y - this.center.y;
                    return Math.sqrt(dx * dx + dy * dy);
                }));
                
                return maxDistance + 30;
            }
            
            update() {
                this.age++;
                this.center = this.calculateCenter();
                
                // è†œã®å®Œå…¨æ€§ã®ç¶­æŒ
                if (this.lipids.length < 5) {
                    this.integrity -= 0.01;
                }
                
                // åŸå§‹ç´°èƒã¸ã®é€²åŒ–ãƒã‚§ãƒƒã‚¯
                if (!this.isProtocell && this.age > 100 && this.integrity > 0.8) {
                    this.attemptProtocellFormation();
                }
                
                // è†œã®æ›´æ–°
                this.lipids = this.lipids.filter(lipid => lipid.energy > 0);
                
                if (this.lipids.length < 3 || this.integrity <= 0) {
                    this.disintegrate();
                    return false;
                }
                
                return true;
            }
            
            attemptProtocellFormation() {
                // è†œå†…ã«ãƒšãƒ—ãƒãƒ‰ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼æºãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const nearbyPeptides = simulation.peptides.filter(pep => {
                    const dx = pep.x - this.center.x;
                    const dy = pep.y - this.center.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    return distance < this.radius;
                });
                
                if (nearbyPeptides.length >= 2 && simulation.environment.energy > 40) {
                    this.isProtocell = true;
                    this.containedMolecules = nearbyPeptides.slice(0, 3);
                    
                    const protocell = new Protocell(this);
                    simulation.protocells.push(protocell);
                    simulation.statistics.protocellsBorn++;
                    
                    addLogEntry(`ğŸ‰ æ­´å²çš„ç¬é–“ï¼åŸå§‹ç´°èƒãŒèª•ç”Ÿã—ã¾ã—ãŸï¼`, 'log-critical');
                    return true;
                }
                
                return false;
            }
            
            disintegrate() {
                this.lipids.forEach(lipid => {
                    lipid.inMembrane = false;
                    lipid.membrane = null;
                });
            }
            
            draw() {
                simulation.ctx.save();
                
                // è†œã®è¼ªéƒ­
                simulation.ctx.strokeStyle = `rgba(255, 255, 255, ${this.integrity * 0.5})`;
                simulation.ctx.lineWidth = 2;
                simulation.ctx.beginPath();
                simulation.ctx.arc(this.center.x, this.center.y, this.radius, 0, Math.PI * 2);
                simulation.ctx.stroke();
                
                // åŸå§‹ç´°èƒã®å ´åˆã¯ç‰¹åˆ¥ãªæç”»
                if (this.isProtocell) {
                    simulation.ctx.fillStyle = `rgba(16, 185, 129, 0.1)`;
                    simulation.ctx.beginPath();
                    simulation.ctx.arc(this.center.x, this.center.y, this.radius, 0, Math.PI * 2);
                    simulation.ctx.fill();
                    
                    // è„ˆå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    const pulse = Math.sin(simulation.time * 0.1) * 3;
                    simulation.ctx.strokeStyle = `rgba(16, 185, 129, 0.8)`;
                    simulation.ctx.lineWidth = 3;
                    simulation.ctx.beginPath();
                    simulation.ctx.arc(this.center.x, this.center.y, this.radius + pulse, 0, Math.PI * 2);
                    simulation.ctx.stroke();
                }
                
                simulation.ctx.restore();
            }
        }
        
        class Protocell {
            constructor(membrane) {
                this.id = `PRO_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.membrane = membrane;
                this.energy = 200;
                this.age = 0;
                this.generation = 1;
                this.replicationCount = 0;
                this.metabolism = 0.1;
                this.replicationEnergy = 300;
                this.color = '#10B981';
                this.size = membrane.radius;
                
                // åŸå§‹ç´°èƒèª•ç”Ÿã‚¤ãƒ™ãƒ³ãƒˆ
                setTimeout(() => {
                    this.showEndCredits();
                }, 3000);
            }
            
            update() {
                this.age++;
                this.energy -= this.metabolism;
                
                // ç’°å¢ƒã‹ã‚‰ã‚¨ãƒãƒ«ã‚®ãƒ¼ç²å¾—
                if (simulation.environment.energy > 20) {
                    this.energy += 0.5;
                    simulation.environment.energy -= 0.1;
                }
                
                // è‡ªå·±è¤‡è£½ã®å¯èƒ½æ€§
                if (this.energy >= this.replicationEnergy && Math.random() < 0.001) {
                    this.replicate();
                }
                
                if (this.energy <= 0) {
                    this.die();
                    return false;
                }
                
                return true;
            }
            
            replicate() {
                this.replicationCount++;
                this.energy *= 0.5;
                this.generation++;
                
                addLogEntry(`åŸå§‹ç´°èƒ #${this.id} ãŒç¬¬${this.replicationCount}å›ç›®ã®åˆ†è£‚ã‚’é‚ã’ã¾ã—ãŸ`, 'log-critical');
            }
            
            die() {
                const index = simulation.protocells.indexOf(this);
                if (index > -1) {
                    simulation.protocells.splice(index, 1);
                }
            }
            
            showEndCredits() {
                document.getElementById('endCredits').style.display = 'flex';
                document.getElementById('currentStage').textContent = 'åŸå§‹ç´°èƒèª•ç”Ÿ';
                document.getElementById('evolutionProgress').textContent = '100%';
                document.getElementById('evolutionProgressBar').style.width = '100%';
            }
            
            draw() {
                // è†œãŒæç”»ã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯ç‰¹åˆ¥ãªæç”»ã¯ã—ãªã„
            }
        }
        
        // ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ====================
        function addLogEntry(message, type = 'log-info') {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${Math.floor(simulation.time / 100)}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            // å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤
            while (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }
        
        function createAminoAcid() {
            const type = SCIENTIFIC_CONSTANTS.AMINO_ACID_TYPES[
                Math.floor(Math.random() * SCIENTIFIC_CONSTANTS.AMINO_ACID_TYPES.length)
            ];
            
            const x = Math.random() * simulation.canvas.width;
            const y = Math.random() * simulation.canvas.height;
            
            // ç’°å¢ƒæ¡ä»¶ã«åŸºã¥ãç”Ÿæˆç¢ºç‡
            const formationChance = SCIENTIFIC_CONSTANTS.PROBABILITIES.AMINO_ACID_FORMATION * 
                                   (simulation.environment.energy / 100) *
                                   (1 + simulation.environment.organicConcentration);
            
            if (Math.random() < formationChance) {
                new AminoAcid(type, x, y);
            }
        }
        
        function createLipid() {
            const type = SCIENTIFIC_CONSTANTS.LIPID_TYPES[
                Math.floor(Math.random() * SCIENTIFIC_CONSTANTS.LIPID_TYPES.length)
            ];
            
            const x = Math.random() * simulation.canvas.width;
            const y = Math.random() * simulation.canvas.height;
            
            const formationChance = SCIENTIFIC_CONSTANTS.PROBABILITIES.LIPID_FORMATION *
                                   (simulation.environment.energy / 80);
            
            if (Math.random() < formationChance) {
                new Lipid(type, x, y);
            }
        }
        
        function checkPeptideFormation() {
            // ã‚¢ãƒŸãƒé…¸é–“ã®è·é›¢ã‚’ãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < simulation.molecules.length; i++) {
                for (let j = i + 1; j < simulation.molecules.length; j++) {
                    const aa1 = simulation.molecules[i];
                    const aa2 = simulation.molecules[j];
                    
                    const dx = aa2.x - aa1.x;
                    const dy = aa2.y - aa1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < aa1.reactionRadius + aa2.reactionRadius) {
                        // åå¿œç¢ºç‡ã®è¨ˆç®—
                        const reactionChance = SCIENTIFIC_CONSTANTS.PROBABILITIES.PEPTIDE_FORMATION *
                                              (simulation.environment.energy / 100) *
                                              (1 + simulation.environment.organicConcentration) *
                                              (1 / (distance + 1));
                        
                        if (Math.random() < reactionChance) {
                            // ãƒšãƒ—ãƒãƒ‰çµåˆå½¢æˆ
                            const peptide = new Peptide([aa1, aa2], 
                                (aa1.x + aa2.x) / 2, 
                                (aa1.y + aa2.y) / 2);
                            
                            // åå¿œã—ãŸã‚¢ãƒŸãƒé…¸ã‚’é™¤å»
                            aa1.energy = 0;
                            aa2.energy = 0;
                            
                            simulation.statistics.successfulReactions++;
                            return;
                        } else {
                            simulation.statistics.failedReactions++;
                        }
                    }
                }
            }
        }
        
        function updateEnvironment() {
            // ç’°å¢ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è‡ªç„¶å¤‰åŒ–
            simulation.environment.temperature += (Math.random() - 0.5) * 0.1;
            simulation.environment.temperature = Math.max(20, Math.min(120, simulation.environment.temperature));
            
            simulation.environment.pH += (Math.random() - 0.5) * 0.01;
            simulation.environment.pH = Math.max(2, Math.min(10, simulation.environment.pH));
            
            // æœ‰æ©Ÿç‰©æ¿ƒåº¦ã®æ›´æ–°
            simulation.environment.organicConcentration += (Math.random() - 0.5) * 0.001;
            simulation.environment.organicConcentration = Math.max(0, Math.min(1, simulation.environment.organicConcentration));
            
            // ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ›´æ–°
            simulation.environment.energy += (Math.random() - 0.45) * 0.5;
            simulation.environment.energy = Math.max(0, Math.min(100, simulation.environment.energy));
            
            // ç’°å¢ƒã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯
            for (const [eventType, eventConfig] of Object.entries(SCIENTIFIC_CONSTANTS.ENVIRONMENT_EVENTS)) {
                if (Math.random() < eventConfig.probability) {
                    triggerEnvironmentEvent(eventType, eventConfig);
                }
            }
        }
        
        function triggerEnvironmentEvent(eventType, config) {
            simulation.environment.energy *= config.energyBoost;
            simulation.environment.organicConcentration *= config.organicBoost;
            
            let eventMessage = '';
            switch (eventType) {
                case 'HYDROTHERMAL_VENT':
                    eventMessage = 'ğŸŒ‹ ç†±æ°´å™´å‡ºå­”æ´»å‹•ãŒæ´»ç™ºåŒ–ï¼ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¢—åŠ ã—ã¾ã—ãŸ';
                    break;
                case 'ELECTRIC_DISCHARGE':
                    eventMessage = 'âš¡ é›·æ”¾é›»ãŒç™ºç”Ÿï¼æœ‰æ©Ÿç‰©åˆæˆãŒä¿ƒé€²ã•ã‚Œã¾ã—ãŸ';
                    break;
                case 'UV_RADIATION':
                    eventMessage = 'â˜€ï¸ ç´«å¤–ç·šç…§å°„ãŒå¢—åŠ ï¼åˆ†å­åå¿œãŒæ´»æ€§åŒ–ã—ã¾ã—ãŸ';
                    break;
            }
            
            addLogEntry(eventMessage, 'log-warning');
        }
        
        function updateStatistics() {
            document.getElementById('aminoAcidCount').textContent = simulation.molecules.length;
            document.getElementById('peptideCount').textContent = simulation.peptides.length;
            document.getElementById('lipidCount').textContent = simulation.lipids.length;
            document.getElementById('protocellCount').textContent = simulation.protocells.length;
            document.getElementById('timeElapsed').textContent = Math.floor(simulation.time / 100);
            
            const totalReactions = simulation.statistics.successfulReactions + simulation.statistics.failedReactions;
            const successRate = totalReactions > 0 ? 
                Math.round((simulation.statistics.successfulReactions / totalReactions) * 100) : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            // é€²æ—ã®è¨ˆç®—
            const progress = Math.min(100, 
                (simulation.time / 5000 * 40) + 
                (simulation.peptides.length * 20) + 
                (simulation.protocells.length * 40)
            );
            document.getElementById('evolutionProgress').textContent = `${Math.round(progress)}%`;
            document.getElementById('evolutionProgressBar').style.width = `${progress}%`;
            
            // æ®µéšã®æ›´æ–°
            let stage = 'åŒ–å­¦é€²åŒ–æœŸ';
            if (simulation.peptides.length > 10) stage = 'ç”Ÿä½“é«˜åˆ†å­å½¢æˆæœŸ';
            if (simulation.lipids.length > 5) stage = 'è†œå½¢æˆæœŸ';
            if (simulation.protocells.length > 0) stage = 'åŸå§‹ç´°èƒèª•ç”Ÿ';
            document.getElementById('currentStage').textContent = stage;
        }
        
        function updateUIValues() {
            document.getElementById('temperatureValue').textContent = simulation.environment.temperature.toFixed(1);
            document.getElementById('pHValue').textContent = simulation.environment.pH.toFixed(1);
        }
        
        // ==================== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ====================
        function simulationLoop() {
            if (!simulation.isRunning) return;
            
            simulation.time += simulation.timeScale;
            
            // ã‚¯ãƒªã‚¢
            simulation.ctx.clearRect(0, 0, simulation.canvas.width, simulation.canvas.height);
            
            // èƒŒæ™¯æç”»
            drawBackground();
            
            // ç’°å¢ƒæ›´æ–°
            updateEnvironment();
            
            // åˆ†å­ç”Ÿæˆ
            createAminoAcid();
            createLipid();
            
            // åå¿œãƒã‚§ãƒƒã‚¯
            checkPeptideFormation();
            
            // å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°
            simulation.molecules = simulation.molecules.filter(molecule => molecule.update());
            simulation.peptides = simulation.peptides.filter(peptide => peptide.update());
            simulation.lipids = simulation.lipids.filter(lipid => lipid.update());
            
            // è†œã®æ›´æ–°
            const membranes = new Set(simulation.lipids.map(lipid => lipid.membrane).filter(m => m));
            membranes.forEach(membrane => {
                if (!membrane.update()) {
                    membrane.disintegrate();
                }
            });
            
            // åŸå§‹ç´°èƒã®æ›´æ–°
            simulation.protocells = simulation.protocells.filter(protocell => protocell.update());
            
            // æç”»
            simulation.molecules.forEach(molecule => molecule.draw());
            simulation.peptides.forEach(peptide => peptide.draw());
            simulation.lipids.forEach(lipid => lipid.draw());
            membranes.forEach(membrane => membrane.draw());
            simulation.protocells.forEach(protocell => protocell.draw());
            
            // UIæ›´æ–°
            updateStatistics();
            updateUIValues();
            
            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ 
            requestAnimationFrame(simulationLoop);
        }
        
        function drawBackground() {
            const ctx = simulation.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, simulation.canvas.height);
            
            gradient.addColorStop(0, 'rgba(2, 8, 23, 0.9)');
            gradient.addColorStop(0.5, 'rgba(12, 74, 110, 0.3)');
            gradient.addColorStop(1, 'rgba(30, 64, 175, 0.1)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, simulation.canvas.width, simulation.canvas.height);
            
            // æµ·åº•ã®è¡¨ç¾
            ctx.fillStyle = 'rgba(55, 65, 81, 0.2)';
            ctx.fillRect(0, simulation.canvas.height * 0.7, simulation.canvas.width, simulation.canvas.height * 0.3);
            
            // ç†±æ°´å™´å‡ºå­”ã®è¡¨ç¾
            for (let i = 0; i < 5; i++) {
                const x = (i * 0.2 + 0.1) * simulation.canvas.width;
                const y = simulation.canvas.height * 0.85;
                
                const ventGradient = ctx.createRadialGradient(x, y, 0, x, y, 50);
                ventGradient.addColorStop(0, `rgba(245, 158, 11, ${0.2 + Math.sin(simulation.time * 0.01 + i) * 0.1})`);
                ventGradient.addColorStop(1, 'rgba(245, 158, 11, 0)');
                
                ctx.fillStyle = ventGradient;
                ctx.beginPath();
                ctx.arc(x, y, 50, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ==================== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ====================
        function initEventListeners() {
            // é–‹å§‹ãƒœã‚¿ãƒ³
            document.getElementById('startBtn').addEventListener('click', () => {
                if (!simulation.isRunning) {
                    simulation.isRunning = true;
                    simulationLoop();
                    addLogEntry('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'log-info');
                }
            });
            
            // ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³
            document.getElementById('pauseBtn').addEventListener('click', () => {
                simulation.isRunning = false;
                addLogEntry('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ', 'log-info');
            });
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
            document.getElementById('resetBtn').addEventListener('click', () => {
                simulation.isRunning = false;
                
                // ãƒªã‚»ãƒƒãƒˆ
                simulation.molecules = [];
                simulation.peptides = [];
                simulation.lipids = [];
                simulation.protocells = [];
                simulation.time = 0;
                simulation.environment = {
                    temperature: SCIENTIFIC_CONSTANTS.INITIAL_TEMPERATURE,
                    pH: SCIENTIFIC_CONSTANTS.INITIAL_PH,
                    ionConcentration: SCIENTIFIC_CONSTANTS.INITIAL_ION_CONCENTRATION,
                    organicConcentration: 0.1,
                    energy: 50
                };
                simulation.statistics = {
                    totalMolecules: 0,
                    successfulReactions: 0,
                    failedReactions: 0,
                    peptidesFormed: 0,
                    lipidsFormed: 0,
                    protocellsBorn: 0,
                    totalTime: 0
                };
                
                document.getElementById('endCredits').style.display = 'none';
                addLogEntry('ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'log-info');
            });
            
            // æ—©é€ã‚Šãƒœã‚¿ãƒ³
            document.getElementById('fastForwardBtn').addEventListener('click', () => {
                simulation.timeScale = simulation.timeScale === 1 ? 3 : 1;
                const speedText = simulation.timeScale === 1 ? 'æ¨™æº–é€Ÿåº¦' : 'æ—©é€ã‚Š (3x)';
                document.getElementById('fastForwardBtn').innerHTML = `<span>${simulation.timeScale === 1 ? 'â©' : 'âµ'}</span> ${speedText}`;
                addLogEntry(`${speedText}ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'log-info');
            });
            
            // åå¿œé€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            document.getElementById('reactionSpeed').addEventListener('input', (e) => {
                const speeds = ['åœæ­¢', 'æ¥µä½é€Ÿ', 'ä½é€Ÿ', 'æ¨™æº–', 'é«˜é€Ÿ', 'æ¥µé«˜é€Ÿ'];
                const value = parseInt(e.target.value);
                document.getElementById('reactionSpeedValue').textContent = speeds[value];
                
                // ç¢ºç‡å®šæ•°ã‚’èª¿æ•´
                const multiplier = [0, 0.1, 0.5, 1, 2, 5][value];
                SCIENTIFIC_CONSTANTS.PROBABILITIES.AMINO_ACID_FORMATION = 0.0001 * multiplier;
                SCIENTIFIC_CONSTANTS.PROBABILITIES.PEPTIDE_FORMATION = 0.00005 * multiplier;
                SCIENTIFIC_CONSTANTS.PROBABILITIES.LIPID_FORMATION = 0.00008 * multiplier;
                SCIENTIFIC_CONSTANTS.PROBABILITIES.PROTOCELL_FORMATION = 0.00001 * multiplier;
            });
            
            // æ¸©åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            document.getElementById('temperature').addEventListener('input', (e) => {
                simulation.environment.temperature = parseFloat(e.target.value);
            });
            
            // pHã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            document.getElementById('pH').addEventListener('input', (e) => {
                simulation.environment.pH = parseFloat(e.target.value);
            });
        }
        
        // ==================== åˆæœŸåŒ– ====================
        function initSimulation() {
            simulation.canvas = document.getElementById('mainCanvas');
            simulation.ctx = simulation.canvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã®èª¿æ•´
            function resizeCanvas() {
                simulation.canvas.width = simulation.canvas.parentElement.clientWidth;
                simulation.canvas.height = simulation.canvas.parentElement.clientHeight;
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            initEventListeners();
            
            // åˆæœŸãƒ­ã‚°
            addLogEntry('ç”Ÿå‘½èµ·æºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'log-info');
            addLogEntry('åˆæœŸåœ°çƒç’°å¢ƒï¼šæ¸©åº¦80â„ƒã€pH5.5ã€é‚„å…ƒçš„å¤§æ°—', 'log-info');
            addLogEntry('åˆ†å­ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ...', 'log-info');
            
            // ç§‘å­¦çš„æ³¨è¨˜ã®è¿½åŠ 
            addScientificNotes();
        }
        
        function addScientificNotes() {
            const notes = [
                {
                    title: "ğŸ§¬ åˆæœŸã‚¢ãƒŸãƒé…¸ã®ç”Ÿæˆ",
                    content: "Miller-Ureyå®Ÿé¨“ï¼ˆ1953å¹´ï¼‰ã«ã‚ˆã‚Šã€CHâ‚„, NHâ‚ƒ, Hâ‚‚, Hâ‚‚Oã®æ··åˆæ°—ä½“ã«æ”¾é›»ã‚’è¡Œã†ã¨ã€ã‚°ãƒªã‚·ãƒ³ã€ã‚¢ãƒ©ãƒ‹ãƒ³ãªã©ã®ã‚¢ãƒŸãƒé…¸ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ãŒå®Ÿè¨¼ã•ã‚Œã¾ã—ãŸã€‚"
                },
                {
                    title: "âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼æºã®å½¹å‰²",
                    content: "ç´«å¤–ç·šã€é›·æ”¾é›»ã€ç†±æ°´å™´å‡ºå­”ã‹ã‚‰ã®ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæœ‰æ©Ÿåˆ†å­ã®å½¢æˆã¨åå¿œã‚’ä¿ƒé€²ã—ã¾ã—ãŸã€‚"
                },
                {
                    title: "ğŸ”— ãƒšãƒ—ãƒãƒ‰çµåˆã®å½¢æˆ",
                    content: "ã‚¢ãƒŸãƒé…¸åŒå£«ãŒè„±æ°´ç¸®åˆã™ã‚‹ã“ã¨ã§ãƒšãƒ—ãƒãƒ‰çµåˆãŒå½¢æˆã•ã‚Œã¾ã™ã€‚ã“ã®åå¿œã¯æ°´ãŒã‚ã‚‹æ¡ä»¶ä¸‹ã§ã¯ä¸åˆ©ã§ã™ãŒã€å¹²æ¹¿å¾ªç’°ã™ã‚‹æ½®ã ã¾ã‚Šã‚„é‰±ç‰©è¡¨é¢ã§ä¿ƒé€²ã•ã‚Œã¾ã—ãŸã€‚"
                },
                {
                    title: "ğŸ›¡ï¸ è„‚è³ªè†œã®é‡è¦æ€§",
                    content: "è„‚è‚ªé…¸ã‚„ãƒªãƒ³è„‚è³ªã¯æ°´ä¸­ã§è‡ªç™ºçš„ã«äºŒé‡è†œã‚’å½¢æˆã—ã€å†…éƒ¨ã®åˆ†å­ã‚’å¤–ç•Œã‹ã‚‰éš”é›¢ã—ã¾ã™ã€‚ã“ã‚ŒãŒåŸå§‹ç´°èƒã®å§‹ã¾ã‚Šã§ã™ã€‚"
                },
                {
                    title: "ğŸ¯ åŸå§‹ç´°èƒã®å®šç¾©",
                    content: "è‡ªå·±è¤‡è£½èƒ½ã€ä»£è¬æ©Ÿèƒ½ã€è†œæ§‹é€ ã®3è¦ç´ ã‚’å‚™ãˆãŸæœ€å°ã®ç”Ÿå‘½å˜ä½ã€‚æœ€åˆã®åŸå§‹ç´°èƒã¯RNAãƒ¯ãƒ¼ãƒ«ãƒ‰ã¨è„‚è³ªè†œã®å…±ç”Ÿã‹ã‚‰ç”Ÿã¾ã‚ŒãŸã¨è€ƒãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚"
                }
            ];
            
            notes.forEach(note => {
                addLogEntry(`${note.title}: ${note.content}`, 'log-info');
            });
        }
        
        // ==================== å®Ÿè¡Œé–‹å§‹ ====================
        window.addEventListener('load', initSimulation);
        
        console.log("ğŸŒŒ å®Œå…¨ç”Ÿå‘½èµ·æºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ èµ·å‹•å®Œäº†");
        console.log("ç§‘å­¦çš„åŸºç›¤: Miller-Ureyå®Ÿé¨“ã€RNAãƒ¯ãƒ¼ãƒ«ãƒ‰ä»®èª¬ã€ç´°èƒå†…å…±ç”Ÿèª¬");
        console.log("å®Ÿè£…æ©Ÿèƒ½: åˆ†å­å‹•åŠ›å­¦ã€åŒ–å­¦åå¿œã€è†œå½¢æˆã€åŸå§‹ç´°èƒé€²åŒ–");
    </script>
</body>
</html>
